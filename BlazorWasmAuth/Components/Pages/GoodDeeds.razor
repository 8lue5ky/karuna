@page "/gooddeeds"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudText Typo="Typo.h5" Class="mb-4 font-semibold">🌟 Gute Taten</MudText>

    <!-- Fester Scrollbereich -->
    <div style="height:75vh; overflow-y:auto;">
        <Virtualize ItemsProvider="LoadGoodDeedsAsync" Context="deed" OverscanCount="3" ItemSize="230">
            <ItemContent>
	            <GoodDeedPost Title="@deed.Title" Content="@deed.Description" />
            </ItemContent>

            <Placeholder>
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            </Placeholder>
        </Virtualize>
    </div>
</MudContainer>

@code {
    private async ValueTask<ItemsProviderResult<GoodDeedDto>> LoadGoodDeedsAsync(ItemsProviderRequest request)
    {
        try
        {
            // Wichtig: verwende startIndex und count
            int startIndex = request.StartIndex;
            int count = request.Count > 0 ? request.Count : 6;

            Console.WriteLine($"→ Lade gute Taten ab Index {startIndex} (Count: {count})");

            var response = await Http.GetFromJsonAsync<PagedResponse>(
                $"api/gooddeeds/paged?startIndex={startIndex}&count={count}");

            if (response is null)
                return new ItemsProviderResult<GoodDeedDto>(Array.Empty<GoodDeedDto>(), 0);

            int totalCount = response.HasMore
                ? startIndex + response.Items.Count + 1
                : startIndex + response.Items.Count;

            return new ItemsProviderResult<GoodDeedDto>(response.Items, totalCount);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden: {ex.Message}", Severity.Error);
            return new ItemsProviderResult<GoodDeedDto>(Array.Empty<GoodDeedDto>(), 0);
        }
    }

    private class PagedResponse
    {
        public List<GoodDeedDto> Items { get; set; } = new();
        public bool HasMore { get; set; }
    }

    public class GoodDeedDto
    {
        public Guid Id { get; set; }
        public string? Title { get; set; }
        public string? Description { get; set; }
        public string? Category { get; set; }
        public string? Username { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}



